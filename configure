#! /usr/bin/env python

import buildlib
from buildlib import *
from time import gmtime, strftime
from os.path import abspath, dirname, join


moduledir = dirname(abspath(__file__))

depdir = os.getenv('LB_UNIVERSE_DEPS', '/opt/logicblox/lb-universe-deps')
home_dir = os.getenv('LOGICBLOX_HOME', '/opt/logicblox')

parse_arguments(
  prefix='/opt/logicblox/s3lib',
  deps = { 
           'logicblox' : home_dir,
           'guava' : depdir,
           'jcommander' : depdir,
           'commons-io' : depdir,
           'commons-codec' : depdir,
           'log4j' : depdir,
           'slf4j' : depdir,
           'aws-java-sdk' : depdir,
           'gcs-java-sdk' : depdir,
           'junit' : home_dir
         })

open_makefile()

emit('version = 0.2')
emit('package_name = s3lib-$(version)')
emit('all : jars')


deps = [
    # old
    # '$(aws_java_sdk)/lib/java/httpcore-4.3.3.jar',
    # '$(aws_java_sdk)/lib/java/httpclient-4.3.6.jar',
    # '$(aws_java_sdk)/lib/java/aws-java-sdk-1.10.20.jar',
    # '$(aws_java_sdk)/lib/java/jackson-annotations-2.5.3.jar',
    # '$(aws_java_sdk)/lib/java/jackson-core-2.5.3.jar',
    # '$(aws_java_sdk)/lib/java/jackson-databind-2.5.3.jar',
    # '$(gcs_java_sdk)/lib/java/google-api-services-storage-v1-rev26-1.19.1.jar',
    # '$(gcs_java_sdk)/lib/java/google-api-client-1.19.1.jar',
    # '$(gcs_java_sdk)/lib/java/google-oauth-client-1.19.0.jar',
    # '$(gcs_java_sdk)/lib/java/google-http-client-1.19.0.jar',
    # '$(gcs_java_sdk)/lib/java/google-http-client-jackson2-1.19.0.jar',

    # min update set required for the aws-java-sdk update
    '$(aws_java_sdk)/lib/java/httpcore-4.4.4.jar',
    '$(aws_java_sdk)/lib/java/httpclient-4.5.2.jar',
    '$(aws_java_sdk)/lib/java/aws-java-sdk-1.11.102.jar',
    '$(aws_java_sdk)/lib/java/jackson-annotations-2.6.0.jar',
    '$(aws_java_sdk)/lib/java/jackson-core-2.6.6.jar',
    '$(aws_java_sdk)/lib/java/jackson-databind-2.6.6.jar',

    # these are originals
    #'$(aws_java_sdk)/lib/java/jackson-annotations-2.5.3.jar',
    #'$(aws_java_sdk)/lib/java/jackson-core-2.5.3.jar',
    #'$(aws_java_sdk)/lib/java/jackson-databind-2.5.3.jar',
    '$(gcs_java_sdk)/lib/java/google-api-services-storage-v1-rev26-1.19.1.jar',
    '$(gcs_java_sdk)/lib/java/google-api-client-1.19.1.jar',
    '$(gcs_java_sdk)/lib/java/google-oauth-client-1.19.0.jar',
    '$(gcs_java_sdk)/lib/java/google-http-client-1.19.0.jar',
    '$(gcs_java_sdk)/lib/java/google-http-client-jackson2-1.19.0.jar',
    
    # full update set if we want to update all the related jars
    # '$(aws_java_sdk)/lib/java/httpcore-4.4.4.jar',
    # '$(aws_java_sdk)/lib/java/httpclient-4.5.2.jar',
    # '$(aws_java_sdk)/lib/java/aws-java-sdk-1.11.102.jar',
    # '$(aws_java_sdk)/lib/java/jackson-annotations-2.6.0.jar',
    # '$(aws_java_sdk)/lib/java/jackson-core-2.6.6.jar',
    # '$(aws_java_sdk)/lib/java/jackson-databind-2.6.6.jar',
    # '$(gcs_java_sdk)/lib/java/google-api-services-storage-v1-rev99-1.22.0.jar',
    # '$(gcs_java_sdk)/lib/java/google-api-client-1.22.0.jar',
    # '$(gcs_java_sdk)/lib/java/google-oauth-client-1.22.0.jar',
    # '$(gcs_java_sdk)/lib/java/google-http-client-1.22.0.jar',
    # '$(gcs_java_sdk)/lib/java/google-http-client-jackson2-1.22.0.jar',

    # unchanged
    '$(guava)/lib/java/guava-15.0.jar',
    '$(jcommander)/lib/java/jcommander-1.29.jar',
    '$(log4j)/lib/java/log4j-1.2.13.jar',
    # '$(slf4j)/lib/java/slf4j-api-1.7.21.jar',
    '$(slf4j)/lib/java/slf4j-api-1.7.10.jar',
    '$(commons_io)/lib/java/commons-io-2.4.jar',
    '$(commons_codec)/lib/java/commons-codec-1.9.jar',
    '$(aws_java_sdk)/lib/java/commons-logging-1.1.3.jar',
    '$(aws_java_sdk)/lib/java/joda-time-2.8.1.jar',

    '$(gcs_java_sdk)/lib/java/jsr305-1.3.9.jar']

resources = []
if buildlib.g_args.debug:
    deps.append('$(slf4j)/lib/java/slf4j-simple-1.7.21.jar')
    resources.append(join(moduledir, 'resources/simplelogger.properties')) 

rev_info = os.getenv('name', 's3lib-1234-0pre').split('-')[1].replace('_', '-')
impl_version = (rev_info + '_' + strftime("%Y%m%d%H%M", gmtime()))
jar(
   name = 's3lib-$(version)',
   srcdirs = ['src'],
   classpath = deps,
   resources = resources,
   javadoc =
     {'title' : "s3lib $(version) API Documentation"},
   manifest = {'add_classpath': True,
               'main_class': "com.logicblox.s3lib.Main",
               'package_version': [('Name', "com.logicblox.s3lib"),
                                   ('Specification-Title', "APIs for cloud storage"),
                                   ('Specification-Version', "1.0"),
                                   ('Specification-Vendor', "LogicBlox, Inc."),
                                   ('Implementation-Title', "com.logicblox.s3lib"),
                                   ('Implementation-Version', impl_version),
                                   ('Implementation-Vendor', "LogicBlox, Inc.")]},
   java_version = "1.7")

test_deps = [
  '$(junit)/lib/java/junit-4.8.2.jar',
  '$(build)/jars/s3lib-$(version).jar']
jar(
   name = 's3lib-test',
   srcdirs = ['test/src'],
   classpath = deps + test_deps,
   manifest = {'add_classpath': True,
               'main_class': "com.logicblox.s3lib.TestRunner"},
   java_version = "1.7")

bin_program('cloud-store')
bin_program('s3tool')

install_files(deps + test_deps, '$(prefix)/lib/java')

dist_files(['README'])

close_makefile()
